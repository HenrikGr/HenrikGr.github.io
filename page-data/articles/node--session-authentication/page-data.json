{"componentChunkName":"component---src-templates-article-page-template-js","path":"/articles/node--session-authentication/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Session authentication in Node.js","subtitle":"When to use session based authentication and some security aspects","date":"2021-04-23","publishedBy":"Henrik Grönvall"},"excerpt":"In order to understand session-based authentication you need to understand HTTP and Cookies which are very common\nto be the bearer of a session id used by the…","timeToRead":5,"html":"<p>In order to understand session-based authentication you need to understand HTTP and Cookies which are very common\nto be the bearer of a session id used by the server to maintain user sessions. There are two types of cookies\nwe can use, session cookie and permanent cookie. A session cookie does not contain Expire or MaxAge attribute and is\nremoved when a user close the browser tab, the permanent cookie does not expire when the client is close, instead\npermanent cookies expire at a specific date (Expires) or after a specific length of time (Max-Age). </p>\n<p>HTTP is a stateless protocol, which means that an HTTP request by default does not maintain state. The server does not\nknow about any previous requests that were sent by the same client.</p>\n<h1>Session-based authentication</h1>\n<p>In session-based authentication, after a user authenticate, the web server send a cookie back to the web browser\ncontaining a session id. At the same time, the web server will also store the session id and, information about the\nauthenticated user in a session store.</p>\n<p>Next time the web browser send a request to the web server, the request will contain this cookie and, the web server use\nthe session id stored in the cookie to load user information from the session store. You can\nconsider this phase as the web server authenticate the user performing the request from the web browser. </p>\n<p>If the cookie has expired, it will not be sent in the request thus the web server can not authenticate the user via the\nsession store meaning the user is not authenticated, the session has expired, the user needs to authenticate again.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 801px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ec224d2a1afedd60e0d42c4f168018d9/d5834/session-based-authentication.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.03571428571428%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAd4QVX//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAEFAl//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAZEAACAwEAAAAAAAAAAAAAAAAAARBBYSH/2gAIAQEAAT8hS0sTwS4XH//aAAwDAQACAAMAAAAQCw//xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPxBn/8QAFhEAAwAAAAAAAAAAAAAAAAAAARAx/9oACAECAQE/EBF//8QAHBABAAMAAgMAAAAAAAAAAAAAAQARITFBgZHw/9oACAEBAAE/EErn4ga2I2Wxre4AOfcDZKPmf//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"SessionAuthentication\"\n        title=\"Session based authentication\"\n        src=\"/static/ec224d2a1afedd60e0d42c4f168018d9/d5834/session-based-authentication.jpg\"\n        srcset=\"/static/ec224d2a1afedd60e0d42c4f168018d9/2bad8/session-based-authentication.jpg 224w,\n/static/ec224d2a1afedd60e0d42c4f168018d9/fb05c/session-based-authentication.jpg 448w,\n/static/ec224d2a1afedd60e0d42c4f168018d9/d5834/session-based-authentication.jpg 801w\"\n        sizes=\"(max-width: 801px) 100vw, 801px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>When to use session-based authentication</h2>\n<p>Session-based authentication is common if you have a full controlled on the server-side, having the server to control\nthe state of the application will ease the client side, and create a more robust application. Session-based\nauthentication is great for browser based applications and, it can restrict or limit session to certain operation or\ncertain time period and, it can invalidate user if there are any security concerns.</p>\n<p>Session-based authentication is also common in environments where you do not need to scale up your system horizontally\n(adding new replicated server instances). In other words, where your number of users is not massive or predictable.\nIf you need to scale up with more servers it's common to use a dedicated session server such as Redis to be a central\nsession store your servers can access.</p>\n<p>Session-based authentication is also quite secure for its use case, by setting HttpOnly flag when generating a cookie\nhelps mitigate the risk of client side script (XSS-attack) accessing the protected cookie.</p>\n<p>Further, cookies can be created with a secure flag setting in the cookie that prevents cookie transmission\nthrough unencrypted channels thus eliminate MiTM-attack (Manipulator in The Middle attack). The secure flag in the\ncookie ensures the browser only sends the cookie over HTTPS.</p>\n<blockquote>\n<p>The session-based authentication does implement a fair amount of protection for its use case, but you need to secure\nyour application using complimentary methods as well.</p>\n</blockquote>\n<h2>Code example in Node.js</h2>\n<p>In Node.js it is common practice to use express-session for Connect styled backends. express-session is a middleware\nyou use where you configure the settings as well as the session store you choose. Below is an example of the\nconfiguration and how to apply the middleware to an express application.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Express <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'express'</span>\n<span class=\"token keyword\">import</span> session<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> Cookie <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'express-session'</span>\n<span class=\"token keyword\">import</span> MongoStore <span class=\"token keyword\">from</span> <span class=\"token string\">'connect-mongo'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> connectionOpts <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../../database/mongo/DbClient'</span>\n\n<span class=\"token comment\">/**\n * Session middleware configuration\n */</span>\n<span class=\"token keyword\">const</span> sessionConfig <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  name<span class=\"token operator\">:</span> <span class=\"token string\">'example.sid'</span><span class=\"token punctuation\">,</span>\n  resave<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  saveUninitialized<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  secret<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SESSION_SECRET</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/**\n * Session duration settings\n */</span>\n<span class=\"token keyword\">const</span> sessionDuration <span class=\"token operator\">=</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SESSION_DURATION</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/**\n * Cookie configuration\n */</span>\n<span class=\"token keyword\">const</span> cookieConfig <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  httpOnly<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// Will not allow client-side JavaScript to access cookie in document.cookie</span>\n  secure<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// Ensures the cookie is sent only over HTTP(S), </span>\n                  <span class=\"token comment\">// to protect against cross-site scripting attacks.</span>\n  sameSite<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// cors</span>\n  maxAge<span class=\"token operator\">:</span> sessionDuration<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/**\n * Session store options\n */</span>\n<span class=\"token keyword\">const</span> storeOptions <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  mongoUrl<span class=\"token operator\">:</span> connectionOpts<span class=\"token punctuation\">.</span>connectionURI<span class=\"token punctuation\">,</span>\n  mongoOptions<span class=\"token operator\">:</span> connectionOpts<span class=\"token punctuation\">.</span>options<span class=\"token punctuation\">,</span>\n  dbName<span class=\"token operator\">:</span> <span class=\"token string\">'UserDb'</span><span class=\"token punctuation\">,</span>\n  ttl<span class=\"token operator\">:</span> sessionDuration <span class=\"token operator\">/</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/**\n * Apply session management to express app\n * @param app\n */</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">applySession</span><span class=\"token punctuation\">(</span>app<span class=\"token operator\">:</span> Express<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token comment\">// In production mode - set the secure flag to true to use HTTPS</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'env'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token string\">'production'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    app<span class=\"token punctuation\">.</span><span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'trust proxy'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// trust first proxy</span>\n    cookieConfig<span class=\"token punctuation\">.</span>secure <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span>\n\n  app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>\n    <span class=\"token function\">session</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span>sessionConfig<span class=\"token punctuation\">,</span>\n      cookie<span class=\"token operator\">:</span> cookieConfig<span class=\"token punctuation\">,</span>\n      store<span class=\"token operator\">:</span> MongoStore<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>storeOptions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The express-session middleware ensure creating a cookie (if no one was sent in the request) or load the cookie from the\nsession store if a cookie was in the request. To ensure authentication in request containing the cookie we can implement\nanother middleware as the example below;</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> NextFunction<span class=\"token punctuation\">,</span> Request<span class=\"token punctuation\">,</span> Response <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'express'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ServiceLogger <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@hgc-sdk/logger'</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserMiddleware</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">private</span> logger<span class=\"token operator\">:</span> ServiceLogger\n  <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span>logger<span class=\"token operator\">:</span> ServiceLogger<span class=\"token punctuation\">,</span> oauthService<span class=\"token operator\">:</span> IOAuthService<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>logger <span class=\"token operator\">=</span> logger\n  <span class=\"token punctuation\">}</span>\n  \n  <span class=\"token comment\">/**\n   * Authenticate user against the session store of session cookie exist\n   */</span>\n  <span class=\"token keyword\">public</span> <span class=\"token function-variable function\">ensureAuthenticated</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>req<span class=\"token operator\">:</span> Request<span class=\"token punctuation\">,</span> res<span class=\"token operator\">:</span> Response<span class=\"token punctuation\">,</span> next<span class=\"token operator\">:</span> NextFunction<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>session <span class=\"token operator\">&amp;&amp;</span> req<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// If session AND user exist - express session has loaded the </span>\n      <span class=\"token comment\">// user information from the session store based on the cookie in the request</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// express-session has created a new cookie and our authetication code should</span>\n      <span class=\"token comment\">// update the req.session with user information if authetication succeed</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2>XSS-attack</h2>\n<p>Cross-Site Scripting (XSS) attacks are a type of injection, in which malicious scripts are injected into otherwise\nbenign and trusted websites. XSS attacks occur when an attacker uses a web application to send malicious code, generally\nin the form of a browser side script, to a different end user. Flaws that allow these attacks to succeed are quite\nwidespread and occur anywhere a web application uses input from a user within the output it generates without validating\nor encoding it.</p>\n<p>An attacker can use XSS to send a malicious script to an unsuspecting user. The end user’s browser has no way to know\nthat the script should not be trusted, and will execute the script. Because it thinks the script came from a trusted\nsource, the malicious script can access any cookies, session tokens, or other sensitive information retained by the\nbrowser and used with that site. These scripts can even rewrite the content of the HTML page.</p>\n<h2>MiTM-attack</h2>\n<p>The Manipulator-in-the middle attack (MITM) intercepts a communication between two systems. For example, in a http\ntransaction the target is the TCP connection between client and server. Using different techniques, the attacker splits\nthe original TCP connection into 2 new connections, one between the client and the attacker and the other between the\nattacker and the server. Once the TCP connection is intercepted, the attacker acts as a proxy, being able to read,\ninsert and modify the data in the intercepted communication.</p>\n<p>The MITM attack could also be done over a https connection by using the same technique; the only difference consists in\nthe establishment of two independent SSL sessions, one over each TCP connection. The browser sets an SSL connection\nwith the attacker, and the attacker establishes another SSL connection with the web server. In general the browser\nwarns the user that the digital certificate used is not valid, but the user may ignore the warning because they don’t\nunderstand the threat. In some specific contexts it’s possible that the warning does not appear, as for example, when\nthe Server certificate is compromised by the attacker or when the attacker certificate is signed by a trusted CA and,\nthe CN is the same of the original web-site.</p>\n<h2>References</h2>\n<ul>\n<li>Set Cookie: <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie\">Set Cookie</a></li>\n<li>XSS-attack: <a href=\"https://owasp.org/www-community/attacks/xss/\">Cross-Site-Scripting (XSS) attacks</a></li>\n<li>MiTM attack: <a href=\"https://owasp.org/www-community/attacks/Manipulator-in-the-middle_attack\">MiTM attacks</a></li>\n</ul>"}},"pageContext":{"slug":"/articles/node--session-authentication/"}},"staticQueryHashes":["4011214723"]}
{"componentChunkName":"component---src-templates-article-page-template-js","path":"/articles/ddd-domain-layer/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Domain Driven Design - The Domain Layer","subtitle":"An example implementation of a domain model","date":"2021-03-01","publishedBy":"Henrik Grönvall"},"excerpt":"In the last article I described the implementation differences between entity objects and value objects \nwhere the most significant difference is that entity…","timeToRead":13,"html":"<p>In the last article I described the implementation differences between entity objects and value objects\nwhere the most significant difference is that entity objects have a lifespan are mutable and have\ntheir own intrinsic identity based on a unique id. Value objects on the other hand, have no lifespan,\nbelongs to entity objects, have no id, are equal by their attributes, are immutable and thus\nrepresent a snapshot of state. I also mentioned that these software artifacts is used in the\ndomain model and implement the business requirements defined by the UbiquitousLanguage.</p>\n<h1>How do we define a domain model?</h1>\n<p>Domain-Driven Design is about designing software based on models of the underlying domain. A model acts\nas a UbiquitousLanguage to help communication between software developers and domain experts. It also\nacts as the conceptual foundation for the design of the software itself - how it's broken down into\nobjects or functions. To be effective, a model needs to be unified - that is to be internally consistent\nso that there are no contradictions within it.</p>\n<p>Modelling a large domain can get hard quickly and building a single unified model is more difficult\nthe bigger organization. More people or groups of people leads to subtle different vocabularies and\ndifferent interpretation in different parts of an organization and modelling often end up in confusion.</p>\n<p>Domain-Driven Design advocates through the strategic concept to divide up large systems into bounded\ncontexts, where each can have a unified model.</p>\n<p>Bounded contexts have both unrelated concepts but also share concepts. Different contexts may have\ncompletely different models of common concepts with mechanisms to map between these uncertain concepts\nfor integration.</p>\n<p>To define a domain model it's therefore important to explicitly define the context within which a\nmodel applies. In the Domain-Driven Design - the Context Map is designated as the primary tool used\nto make context boundaries explicit.</p>\n<h1>Software artifacts in domain models</h1>\n<p>I have already mentioned entity objects and value objects as software artifacts commonly used in the\ndomain layer and will now touch other artifacts such as aggregates, domain services, and domain events.\nAll elements in the domain layer are only dependent on each other and actively avoid dependencies any\nouter layers.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a08f37c2356b310f9e82ff80d84e579b/5a190/ddd-architecture-doman-layer.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.32142857142857%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABdUlEQVQoz32SS0/CQBSFuxFidINRUDHGlgYVBAqERwVK59EZKAtj3Bg3gLgQtv4WN27d+R/NcToIEYIsTm6aSb57zzk1CKGglMAnBCLgoG4BjXwazfwp3MI5JHHBGAdR75F8318q+qaULmckI4IRDQvQdkxYRzE8iAae7ihYLQs7uQPpN0AoA2cMg8EAYRhqrcPmwGgz5ZDdOjLJGGTbQdjJYdy/Am8V0XEuUDQTkIKBKuB4NMJ0OtVzcfUKkBAfXEjUbky4uRPUixY+Hg18vxt47RholG9QNvfA/JYGvkwmmM1mGA6HkFL+AwwUsPALVPPr2QA+DbwxAzUnj4q5D66Ake2w39d2I+tCiC2WVU52Kq4te8UU7qtxeFUbnrLsWAfoCa6LWxTS7Xa3lxKoUrxKBtljBarYaFUu4aq2r9O7allTL6Vr12wsZfW3CcBuSyjbhyhZCdTzZ+jRtsqOb7xmk+aW/0AZD3Q2QSDmGancVmHbgT+IMDgXDB/zFwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Architecture\"\n        title=\"Domain Layer\"\n        src=\"/static/a08f37c2356b310f9e82ff80d84e579b/5a190/ddd-architecture-doman-layer.png\"\n        srcset=\"/static/a08f37c2356b310f9e82ff80d84e579b/80b2d/ddd-architecture-doman-layer.png 224w,\n/static/a08f37c2356b310f9e82ff80d84e579b/33b38/ddd-architecture-doman-layer.png 448w,\n/static/a08f37c2356b310f9e82ff80d84e579b/5a190/ddd-architecture-doman-layer.png 800w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Aggregates</h2>\n<p>Aggregate is a pattern in Domain-Driven Design. An aggregate is a cluster of domain objects that can\nbe treated as a single unit and will have one of its component objects be the aggregate root. Any\nreferences from outside the aggregate should only go to the aggregate root. The root can thus ensure the\nintegrity of the aggregate as a whole.</p>\n<p>Aggregates are the basic element of transfer of data storage - you request to load or save whole aggregates.\nTransactions should not cross aggregate boundaries.</p>\n<h2>Domain Events</h2>\n<p>A domain event is, something that happened in the domain that you want other parts of the same domain\nto be aware of. The notified parts usually react somehow to the events. An important benefit\nof domain events is that side effects can be expressed explicitly.</p>\n<p>The essence of a domain event is that you use it to capture things that can trigger a change to the\nstate of the application you are developing.</p>\n<h2>Domain Service</h2>\n<p>The domain service consist of methods that don’t really fit on a single entity or require access to the\napplication services. The domain service can also contain domain logic of its own and is as much part of\nthe domain model as entities and value objects.</p>\n<h1>Register User - a use case to put it all together</h1>\n<p>It's time for some code examples and when I have played with Domain-Driven Design concepts, in Typescript,\nI have focused on user account as a domain or bounded context. Use cases is in my opinion a great method\nto model and designing software. The challenge has been to map it into the software artifacts\nof Domain-Driven Design.</p>\n<h2>Business requirements</h2>\n<p>The requirements of the use case \"Register User\" can be written like this.</p>\n<h3>Objective</h3>\n<p>The purpose of the use case is to allow anyone to register for the application and when done an email\nverification should be sent to the registered email address with a verification token in a link for\nthe user to verify the registration.</p>\n<h3>The business rules are</h3>\n<p>A user who register to the application must enter;</p>\n<ul>\n<li>a username: must be at least 5 chars long and not longer than 15 chars,</li>\n<li>a password: must be 6 to 20 characters and at least one numeric, one uppercase and one lowercase,</li>\n<li>an email address: must be a valid email address form</li>\n</ul>\n<p>The user to be created must setting default values for other properties such as,</p>\n<ul>\n<li>scope = profile,</li>\n<li>isEmailVerified = false,</li>\n<li>isAdmin = false,</li>\n<li>isDeleted = false.</li>\n</ul>\n<p>There must NOT be possible to overwrite an existing user. </p>\n<ul>\n<li>A user marked for deletion is still existing.</li>\n<li>A user can only have one username and one email address.</li>\n</ul>\n<h3>External boundaries</h3>\n<p>When the user account is created, the email verification services must be informed in order to send out\na verification email. The email verification system will in a soon future be replaced with a message\ninfrastructure.</p>\n<h2>Register User - implementing the domain model</h2>\n<p>Time to focus on the implementation of the domain model based derived from the business requirements and using\nDomain-Driven Design software artifacts.</p>\n<p>In our use case, the aggregate root for the domain is the User object. The interface of the User will be expressed\nas a Typescript interface and have the following shape;</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IUserProps</span> <span class=\"token punctuation\">{</span>\n  username<span class=\"token operator\">:</span> UserName <span class=\"token comment\">// Value object</span>\n  email<span class=\"token operator\">:</span> UserEmail  <span class=\"token comment\">// Value object</span>\n  credential<span class=\"token operator\">?</span><span class=\"token operator\">:</span> UserCredential <span class=\"token comment\">// Value object</span>\n  scope<span class=\"token operator\">?</span><span class=\"token operator\">:</span> UserScope\n  isEmailVerified<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span>\n  isAdminUser<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span>\n  isDeleted<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>We know that username, password and email will be received as inputs to the use case and, they will be\nimplemented as value objects since they belong to the User object, the rest of the parameters will be set\nwith default values when creating the User object. The implementation of the value object UserName\ncan be seen below;</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ValueObject <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../../core/domain/ValueObject'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Result <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../../core/common/Result'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Guard <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../../core/common/Guard'</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IUserNameProps</span> <span class=\"token punctuation\">{</span>\n  username<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserName</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ValueObject<span class=\"token operator\">&lt;</span>IUserNameProps<span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Validation rules</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> maxLength<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token operator\">=</span> <span class=\"token number\">15</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> minLength<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span> <span class=\"token operator\">=</span> <span class=\"token number\">5</span>\n  \n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token operator\">:</span> IUserNameProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// getter for the value</span>\n  <span class=\"token keyword\">get</span> <span class=\"token function\">value</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>username\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">/**\n   * Factory method to create an instance and apply the validation rules\n   * @param username The user name\n   */</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span>username<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Result<span class=\"token operator\">&lt;</span>UserName<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> minLengthResult <span class=\"token operator\">=</span> Guard<span class=\"token punctuation\">.</span><span class=\"token function\">againstAtLeast</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>minLength<span class=\"token punctuation\">,</span> username<span class=\"token punctuation\">,</span> <span class=\"token string\">'username'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>minLengthResult<span class=\"token punctuation\">.</span>isSuccess<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> Result<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">fail</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>UserName<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>minLengthResult<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">const</span> maxLengthResult <span class=\"token operator\">=</span> Guard<span class=\"token punctuation\">.</span><span class=\"token function\">againstAtMost</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>maxLength<span class=\"token punctuation\">,</span> username<span class=\"token punctuation\">,</span> <span class=\"token string\">'username'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>maxLengthResult<span class=\"token punctuation\">.</span>isSuccess<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> Result<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">fail</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>UserName<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>maxLengthResult<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> Result<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">ok</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>UserName<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">UserName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>username<span class=\"token operator\">:</span> username<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Q) Why do I not inject the creation of the UserName object to the User object and perform the\nvalidation there?</p>\n<p>A) Single responsibility rule: validation rules belong to UserName and not User.</p>\n<p>Q) Why do I implement a factory method and using a private constructor to create a value object?</p>\n<p>A) I have chosen this approach in order to enforce object creation rules, when using the \"new\" keyword to\ncreate objects there is not in my view an elegant way to enforce validation rules. Throwing errors\nin the constructor can be done but is not elegant and sometimes the creation of the stored value\n(expressed as props) may need an async function and that is not possible/recommended. For example, I do not store the plain\ntext of the password in the UserCredential value object - instead I store the salted and hashed\npassword. Salt and hash a password should in Node.js be implemented as an async function.</p>\n<p>The other objects - UserCredential and UserEmail - belongs to the User object follows the same\nimplementation design and, I do not provide code examples, they do provide a public static factory method and uses\nprivate constructors as well. </p>\n<p>As you can see, this way we can implement the business requirements from the use case\ndescription;</p>\n<ul>\n<li>a username, must be at least 5 chars long and not longer than 15 chars,</li>\n<li>a password, must be 6 to 20 characters and at least one numeric, one uppercase and one lowercase,</li>\n<li>an email address, must be a valid email address form</li>\n</ul>\n<p>Now we head over to the implementation of the User object; </p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Result <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../../core/common/Result'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> AggregateRoot <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../../core/domain/AggregateRoot'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> UniqueEntityID <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../../core/domain/UniqueEntityID'</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> UserDomainEvent<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./events/UserDomainEvent'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> UserName <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./userName'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> UserEmail <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./userEmail'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> UserCredential <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./UserCredential'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> UserScope <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./userScope'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> UserId <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./UserId'</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AggregateRoot<span class=\"token operator\">&lt;</span>IUserProps<span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span>props<span class=\"token operator\">:</span> IUserProps<span class=\"token punctuation\">,</span> id<span class=\"token operator\">?</span><span class=\"token operator\">:</span> UniqueEntityID<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  \n  <span class=\"token keyword\">get</span> <span class=\"token function\">id</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UniqueEntityID <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_id\n  <span class=\"token punctuation\">}</span>\n  \n  <span class=\"token keyword\">get</span> <span class=\"token function\">username</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UserName <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>username\n  <span class=\"token punctuation\">}</span>\n  \n  <span class=\"token keyword\">get</span> <span class=\"token function\">email</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UserEmail <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>email\n  <span class=\"token punctuation\">}</span>\n  \n  <span class=\"token keyword\">get</span> <span class=\"token function\">credential</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UserCredential <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>UserCredential<span class=\"token operator\">></span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>credential\n  <span class=\"token punctuation\">}</span>\n  \n  <span class=\"token keyword\">get</span> <span class=\"token function\">isEmailVerified</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>isEmailVerified\n  <span class=\"token punctuation\">}</span>\n  \n  <span class=\"token keyword\">set</span> <span class=\"token function\">isEmailVerified</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>isEmailVerified <span class=\"token operator\">=</span> value\n    <span class=\"token comment\">// Create a domain event if email has been verified</span>\n    <span class=\"token keyword\">const</span> userEmailverified <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UserDomainEvent</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> <span class=\"token string\">'META: Changed isEmailVerified'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">addDomainEvent</span><span class=\"token punctuation\">(</span>userEmailverified<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  \n  <span class=\"token keyword\">get</span> <span class=\"token function\">isAdminUser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>isAdminUser\n  <span class=\"token punctuation\">}</span>\n  \n  <span class=\"token keyword\">get</span> <span class=\"token function\">isDeleted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>isDeleted\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">/**\n   * Factory method creating the User entity\n   * @param {IUserProps} props\n   * @param {UniqueEntityID} id\n   * @return {Result&lt;User>}\n   */</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span>props<span class=\"token operator\">:</span> IUserProps<span class=\"token punctuation\">,</span> id<span class=\"token operator\">?</span><span class=\"token operator\">:</span> UniqueEntityID<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Result<span class=\"token operator\">&lt;</span>User<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Creates a new User object and sets default values</span>\n    <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>props<span class=\"token punctuation\">,</span>\n        scope<span class=\"token operator\">:</span> props<span class=\"token punctuation\">.</span>scope <span class=\"token operator\">?</span> props<span class=\"token punctuation\">.</span>scope <span class=\"token operator\">:</span> UserScope<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> value<span class=\"token operator\">:</span> <span class=\"token string\">'profile'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        isDeleted<span class=\"token operator\">:</span> props<span class=\"token punctuation\">.</span>isDeleted <span class=\"token operator\">?</span> props<span class=\"token punctuation\">.</span>isDeleted <span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        isEmailVerified<span class=\"token operator\">:</span> props<span class=\"token punctuation\">.</span>isEmailVerified <span class=\"token operator\">?</span> props<span class=\"token punctuation\">.</span>isEmailVerified <span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        isAdminUser<span class=\"token operator\">:</span> props<span class=\"token punctuation\">.</span>isAdminUser <span class=\"token operator\">?</span> props<span class=\"token punctuation\">.</span>isAdminUser <span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      id\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// if a new user entity was created - create a domain event</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> userCreated <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UserDomainEvent</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> <span class=\"token string\">'META: new user created'</span><span class=\"token punctuation\">)</span>\n      user<span class=\"token punctuation\">.</span><span class=\"token function\">addDomainEvent</span><span class=\"token punctuation\">(</span>userCreated<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> Result<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">ok</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>User<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Q) Why does the User inherits from AggregateRoot?</p>\n<p>A) The AggregateRoot implements logic for the domain service to handle domain events. Our User entity object now\ninherits from the AggregateRoot and thus have access to creating, dispatching and deleting  domain events and as you\ncan se we have implemented to create a new domain event when a new User object is created. The logic to detect if we\nare creating a new User is based on the id parameter passed into the factory function. If we do not get an id it is a\nnew user, we would assume if we get an id it comes from an existing User object, that we have loaded in from a database.</p>\n<p>You can also note we are setting default values to the other properties when creating the User object. Just as\nrequirements told us.</p>\n<p>If you are curious about the implementation of the abstract AggregateRoot class and, the DomainEvent class,\nhere they are:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Entity <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./Entity'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> IDomainEvent <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./events/IDomainEvent'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> DomainEvents <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./events/DomainEvents'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> UniqueEntityID <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./UniqueEntityID'</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AggregateRoot<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Entity<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">protected</span> _domainEvents<span class=\"token operator\">:</span> IDomainEvent<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">get</span> <span class=\"token function\">id</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> UniqueEntityID <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_id\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">get</span> <span class=\"token function\">domainEvents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> IDomainEvent<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_domainEvents\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">public</span> <span class=\"token function\">addDomainEvent</span><span class=\"token punctuation\">(</span>domainEvent<span class=\"token operator\">:</span> IDomainEvent<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_domainEvents<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>domainEvent<span class=\"token punctuation\">)</span>\n    DomainEvents<span class=\"token punctuation\">.</span><span class=\"token function\">markAggregateForDispatch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">public</span> <span class=\"token function\">dispatchDomainEvents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    DomainEvents<span class=\"token punctuation\">.</span><span class=\"token function\">dispatchEventsForAggregate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">clearEvents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">public</span> <span class=\"token function\">clearEvents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_domainEvents<span class=\"token punctuation\">.</span><span class=\"token function\">splice</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_domainEvents<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> IDomainEvent <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../../../core/domain/events/IDomainEvent'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> UniqueEntityID <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../../../core/domain/UniqueEntityID'</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">UserDomainEvent</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">IDomainEvent</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> dateTimeOccurred<span class=\"token operator\">:</span> Date\n  <span class=\"token keyword\">public</span> meta<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span>\n  <span class=\"token keyword\">public</span> aggregateId<span class=\"token operator\">:</span> UniqueEntityID\n  <span class=\"token keyword\">public</span> eventType<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token string\">'UserDomainEvent'</span>\n\n  <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span>aggregateId<span class=\"token operator\">:</span>UniqueEntityID <span class=\"token punctuation\">,</span> meta<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">type</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>dateTimeOccurred <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>aggregateId <span class=\"token operator\">=</span> aggregateId\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>meta <span class=\"token operator\">=</span> meta\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>eventType <span class=\"token operator\">=</span> <span class=\"token keyword\">type</span>\n <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>So far we have implemented the domain logic to the use case of register a user based on the business\nrequirements but what about the use case implementation?</p>\n<h2>Register User - implementing the use case</h2>\n<p>Now we are thinking about the application layer in Domain-Driven Design where use cases belong. If we compare Uncle Bobs\nClean Architecture with Domain-Driven Design, the application layer in Domain-Driven Design roughly correspond\nto the application business rules layer in Clean Architecture, which implements use case or user stories. The\nDomain-Driven Design terminology is trying to make a distinction between application services which depend on\nthe domain layer, and domain services, which take part in implementing the domain logic.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/294531728121a702107f04296e5c8419/5a190/ddd-architecture-application-layer-first.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.32142857142857%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABoElEQVQoz32SS0/bQBSFZwOoajdUFFqoKhIs2hISnKAkGPKYGY9t8iBgIUHVSFRJN93zW9iwZdf/WH2MJyQkCHVxNZ7XN+fcY6GURmuFVIo4MuigSL2wxVFhk6D4hUQFhKFB2X2tNVJK2u32pOx3Ns/Ws/2sRAZTDhbR8HPkPyxzGdf5ea4Jq7t460skso62UG3Pdbtd+v0+vV7PVZIkM2hWIjuktCFp19hZXyZp+HSbe4w63zAnJZr+NqXcKqexsaok11dX/B6P+XVz42o4HJKmqXURThQqJTFxQnU/R7D3iVopz/0Pwb87wZ+moF7ep7z9FiMb1qLifDBgNBo56ODsDGMMcRzPbE+AkQUWn4B2/DsW8CC4DQVVv0Al984BpQWmFxdOZWa30+k4u9P+LVq2ffI2VpzlVmmD9HCF1qFHy1r28++dZekuPocy37uZwmkokQ2lVdlh96MFVTxOKl8JbNrft97Yx47co/pJxUvI/Fws/jYR4fEBZW+Ng/wqtcJnTnXDJTy9qF6BLgCd5TloaCLX5CiK3ah0+AL2f+AjyxQ4xGSwMWkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Architecture\"\n        title=\"Application Layer\"\n        src=\"/static/294531728121a702107f04296e5c8419/5a190/ddd-architecture-application-layer-first.png\"\n        srcset=\"/static/294531728121a702107f04296e5c8419/80b2d/ddd-architecture-application-layer-first.png 224w,\n/static/294531728121a702107f04296e5c8419/33b38/ddd-architecture-application-layer-first.png 448w,\n/static/294531728121a702107f04296e5c8419/5a190/ddd-architecture-application-layer-first.png 800w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>There is so many layers I manage to write in one article though. I will go through the use case implementation\nin more details in the next article but below you can se the code for my implementation of the \"create user\"\nuse case.</p>\n<p>As your already can see in the code, more software artifacts shows up and needs a detailed explanation. I\nwill try to describe, Repository, DTO, Mappers and the use case associated Response type and how they fit into\nthe application layer of Domain-Driven Design.</p>\n<p>Example code of the use case implementation:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-typescript line-numbers\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> AppError <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../../../core/common/AppError'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Result<span class=\"token punctuation\">,</span> left<span class=\"token punctuation\">,</span> right <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../../../core/common/Result'</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> DomainEvents <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../../../core/domain/events/DomainEvents'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> UseCase <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../../../core/domain/UseCase'</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> IUserRepo <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../repos/userRepo'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ICreateUserDTO <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./CreateUserDTO'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> CreateUserErrors <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./CreateUserErrors'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> CreateUserResponse <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./CreateUserResponse'</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> User <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../domain/User'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> UserName <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../domain/userName'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> UserEmail <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../domain/userEmail'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> UserCredential <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../domain/UserCredential'</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> UserDomainEvent <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../domain/events/UserDomainEvent'</span>\n\n<span class=\"token comment\">/**\n * Implements use case logic\n * @class\n */</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CreateUser</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">UseCase<span class=\"token operator\">&lt;</span>ICreateUserDTO<span class=\"token punctuation\">,</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>CreateUserResponse<span class=\"token operator\">>></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">private</span> userRepo<span class=\"token operator\">:</span> IUserRepo\n\n  <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span>userRepo<span class=\"token operator\">:</span> IUserRepo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>userRepo <span class=\"token operator\">=</span> userRepo\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">/**\n   * Implementation of the use case command\n   * @param createUserDTO\n   */</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token function\">executeCommand</span><span class=\"token punctuation\">(</span>createUserDTO<span class=\"token operator\">:</span> ICreateUserDTO<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>CreateUserResponse<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> user<span class=\"token operator\">:</span> User\n    <span class=\"token keyword\">let</span> username<span class=\"token operator\">:</span> UserName\n    <span class=\"token keyword\">let</span> credential<span class=\"token operator\">:</span> UserCredential\n    <span class=\"token keyword\">let</span> email<span class=\"token operator\">:</span> UserEmail\n\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\n      <span class=\"token comment\">// Create value objects from DTO</span>\n      <span class=\"token keyword\">const</span> isValidUserName<span class=\"token operator\">:</span> Result<span class=\"token operator\">&lt;</span>UserName<span class=\"token operator\">></span> <span class=\"token operator\">=</span> UserName<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>createUserDTO<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> isValidUserCredential<span class=\"token operator\">:</span> Result<span class=\"token operator\">&lt;</span>UserCredential<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> UserCredential<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>createUserDTO<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> isValidUserEmail<span class=\"token operator\">:</span> Result<span class=\"token operator\">&lt;</span>UserEmail<span class=\"token operator\">></span> <span class=\"token operator\">=</span> UserEmail<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>createUserDTO<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">const</span> combinedResult <span class=\"token operator\">=</span> Result<span class=\"token punctuation\">.</span><span class=\"token function\">combine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>isValidUserName<span class=\"token punctuation\">,</span> isValidUserCredential<span class=\"token punctuation\">,</span> isValidUserEmail<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>combinedResult<span class=\"token punctuation\">.</span>isSuccess<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">left</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">CreateUserErrors</span><span class=\"token punctuation\">.</span><span class=\"token function\">ValidationError</span><span class=\"token punctuation\">(</span>combinedResult<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> CreateUserResponse\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token comment\">// The value objects where ok - get them</span>\n      username <span class=\"token operator\">=</span> isValidUserName<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      credential <span class=\"token operator\">=</span> isValidUserCredential<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      email <span class=\"token operator\">=</span> isValidUserEmail<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n      <span class=\"token comment\">// Check if user already exist and if so validate according to our business rules</span>\n      <span class=\"token comment\">// Pay attention to that we are searching for an existing user with username and email</span>\n      <span class=\"token comment\">// combined in a unique index in the database</span>\n      <span class=\"token keyword\">let</span> foundUser<span class=\"token operator\">:</span> User <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span>User<span class=\"token operator\">></span><span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>userRepo<span class=\"token punctuation\">.</span><span class=\"token function\">exists</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">,</span> email<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>foundUser<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        \n        <span class=\"token comment\">// The user existed but was marked for deletion</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>foundUser<span class=\"token punctuation\">.</span>isDeleted<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> <span class=\"token function\">left</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">CreateUserErrors</span><span class=\"token punctuation\">.</span><span class=\"token function\">UserIsMarkedForDeletion</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> CreateUserResponse\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token comment\">// The user existed adn the username is already taken</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>foundUser<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> <span class=\"token function\">left</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">CreateUserErrors</span><span class=\"token punctuation\">.</span><span class=\"token function\">UsernameTaken</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> CreateUserResponse\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// The user existed and the email address existed</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>foundUser<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> <span class=\"token function\">left</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">CreateUserErrors</span><span class=\"token punctuation\">.</span><span class=\"token function\">EmailAlreadyExists</span><span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> CreateUserResponse\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token comment\">// The User does not exists - create a User object</span>\n      <span class=\"token keyword\">const</span> isValidUser<span class=\"token operator\">:</span> Result<span class=\"token operator\">&lt;</span>User<span class=\"token operator\">></span> <span class=\"token operator\">=</span> User<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> username<span class=\"token punctuation\">,</span> email<span class=\"token punctuation\">,</span> credential <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isValidUser<span class=\"token punctuation\">.</span>isFailure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">left</span><span class=\"token punctuation\">(</span>Result<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">fail</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>User<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>isValidUser<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> CreateUserResponse\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token comment\">// The User object is valid - get it</span>\n      user <span class=\"token operator\">=</span> isValidUser<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n      <span class=\"token comment\">// Save the user</span>\n      <span class=\"token comment\">// We are passing an aggregate root to the repository</span>\n      <span class=\"token keyword\">const</span> isSaved <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>userRepo<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span>\n\n      <span class=\"token comment\">// If user where saved properly - dispatch all events for the aggregate root</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isSaved<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        DomainEvents<span class=\"token punctuation\">.</span><span class=\"token function\">dispatchEventsForAggregate</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token comment\">// Return void since the use case is a command</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">right</span><span class=\"token punctuation\">(</span>Result<span class=\"token punctuation\">.</span><span class=\"token generic-function\"><span class=\"token function\">ok</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">left</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">AppError</span><span class=\"token punctuation\">.</span><span class=\"token function\">UnexpectedError</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> CreateUserResponse\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h1>Summary</h1>\n<p>In this article I have continue put a focus on the ubiquitous language and how important it is to be able\nto model business requirements with a focus on bounded context in order to design great unified domain models.</p>\n<p>I have described how to implement the domain layer using common DDD software artifacts based on business\nrequirements expressed in use case format.</p>\n<p>I have touched how to use tools such as \"use cases or user stories\" to cover business requirements and mentioned\ncontext mapping as another tool to use. </p>\n<p>I have also shared my experimental code and hope you can be merciful for any obvious bugs or mistakes.</p>\n<p>Bear in mind I'm doing this on my spare time, and unfortunately I have plenty of it and doing it all alone\nwith no other to brainstorm with, which is not satisfying. </p>\n<p>I love it though and apart from learning DDD I'm also learning Typescript and refreshing my mental thinking. </p>\n<p>However, If you think I can add value to your business, do not hesitate to contact me. I would love communicating\nwith other peers and solve real problems.</p>\n<p>Happy coding. :-)</p>"}},"pageContext":{"slug":"/articles/ddd-domain-layer/"}},"staticQueryHashes":["4011214723"]}
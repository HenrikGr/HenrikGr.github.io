{"componentChunkName":"component---src-templates-article-page-template-js","path":"/articles/nodejs-worker-threads/","result":{"data":{"markdownRemark":{"frontmatter":{"title":"Node.js worker threads","subtitle":"What is worker threads and - when and, how to use them in Node.js","date":"2019-11-14","publishedBy":"Henrik Grönvall"},"excerpt":"Worker Threads are available in the Node.js module. Before we dive into my example use of Worker threads in Node.js,\r\nwe will see what are worker threads and…","timeToRead":6,"html":"<p>Worker Threads are available in the Node.js module. Before we dive into my example use of Worker threads in Node.js,\r\nwe will see what are worker threads and why we \"could\" need it in Node.js.</p>\n<h1>Understand Node.js and worker threads</h1>\n<p>When a Node.js process is launched, it runs:</p>\n<ol>\n<li>One process:\r\nA process is a global object that can be accessed anywhere and has information about what’s being executed at a time.</li>\n<li>One thread:\r\nBeing single-threaded means that only one set of instructions is executed at a time in a given process.</li>\n<li>One event loop:\r\nThis is one of the most important aspects to understand about Node. It’s what allows Node to be asynchronous and have\r\nnon-blocking I/O, — despite the fact that JavaScript is single-threaded — by offloading operations to the system kernel\r\nwhenever possible through callbacks, promises and async/await.</li>\n<li>One JS Engine Instance:\r\nThis is a computer program that executes JavaScript code.</li>\n<li>One Node.js Instance:\r\nThe computer program that executes Node.js code.</li>\n</ol>\n<p>In other words, Node.js runs on a single thread, and there is just one process happening at a time in the event loop.\r\nThe code is NOT executed in parallel and you do not need to worry about concurrency issues.</p>\n<p><b>There is a downside tough</b>: if you have CPU-intensive code, like complex calculations in a large dataset taking\r\nplace in-memory, it can block other processes from being executed.</p>\n<blockquote>\n<p>The golden rule: don’t block the event loop, try to keep it running and pay attention and avoid anything that could</p>\n</blockquote>\n<p>block the thread like synchronous network calls or infinite loops.</p>\n<p>It’s important to differentiate between CPU operations and I/O (input/output) operations. As mentioned earlier, the code\r\nof Node.js is NOT executed in parallel. Only I/O operations are run in parallel, because they are executed asynchronously.</p>\n<p>So Worker Threads will not help much with I/O-intensive work because asynchronous I/O operations are more efficient than\r\nWorkers can be. The main goal of Workers is to improve the performance on CPU-intensive operations not I/O operations.</p>\n<h2>When to use worker threads?</h2>\n<p>The best solution for CPU performance is Worker Threads. Browsers have had the concept of Workers for a long time.</p>\n<p>Instead of having:</p>\n<ol>\n<li>One process</li>\n<li>One thread</li>\n<li>One event loop</li>\n<li>One JS Engine Instance</li>\n<li>One Node.js Instance</li>\n</ol>\n<p>Worker threads have:</p>\n<ol>\n<li>One process</li>\n<li>Multiple threads</li>\n<li>One event loop per thread</li>\n<li>One JS Engine Instance per thread</li>\n<li>One Node.js Instance per thread</li>\n</ol>\n<h2>Experiment</h2>\n<p>In my example I have an external service that can be \"considered\" having CPU intensive calculations, it is a Rest API\r\nendpoint built to enable long polling and can after 15 seconds require the client to make a new request. If 15 seconds\r\nhas been reached the service responds with a status 204. The external services will in normal cases respond with event\r\ndata from trot races with a start and finish event and id plus time for any horse in the race.</p>\n<p>The external service will respond with event data for start time and finnish time for horses in trot races:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token comment\">// Start data</span>\r\n<span class=\"token punctuation\">{</span>\r\n  event<span class=\"token operator\">:</span> <span class=\"token string\">\"start\"</span><span class=\"token punctuation\">,</span>\r\n  horse<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n    id<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\r\n    name<span class=\"token operator\">:</span> <span class=\"token string\">'Spin Scorpion'</span> \r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  time<span class=\"token operator\">:</span> <span class=\"token number\">0</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token comment\">// Goal data</span>\r\n<span class=\"token punctuation\">{</span>\r\n  event<span class=\"token operator\">:</span> <span class=\"token string\">\"finish\"</span><span class=\"token punctuation\">,</span>\r\n  horse<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n    id<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\r\n    name<span class=\"token operator\">:</span> <span class=\"token string\">'Spin Scorpion'</span> \r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  time<span class=\"token operator\">:</span> <span class=\"token number\">13230</span>\r\n<span class=\"token punctuation\">}</span>\r\n</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>First we start by implementing the Node.js server using Express.js that are going to run the worker threads for subscribing\r\non trot race data and storing it in the database.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token comment\">// server.js</span>\r\n\r\n<span class=\"token keyword\">const</span> config <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./config\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">const</span> http <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"express\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">const</span> run <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./services\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token comment\">/**\r\n * Run worker threads to subscribe and save data\r\n */</span>\r\n<span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\nserver<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>port<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span>\r\n    <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>config<span class=\"token punctuation\">.</span>appName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> listening on: http://localhost:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>config<span class=\"token punctuation\">.</span>port<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\r\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> server<span class=\"token punctuation\">;</span>\r\n</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The module responsible for all communication between the main thread and the worker threads exports only one\r\nasync function, called run and in this little experiment it starts everything.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token comment\">// .server/services/index.js</span>\r\n\r\n<span class=\"token comment\">/**\r\n * We import the Node.js module for worker threads\r\n */</span>\r\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> Worker <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"worker_threads\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token comment\">/**\r\n * Services that handles all messages between \r\n * the main thread and worker threads\r\n * @returns {Promise&lt;void>}\r\n */</span>\r\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">runService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// Create two new worker threads, </span>\r\n  <span class=\"token comment\">// - on for subscription of trot events, </span>\r\n  <span class=\"token comment\">// - one to store event data in a MongoDb </span>\r\n  <span class=\"token keyword\">const</span> subscribeWorker <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./server/services/subscribeWorker.js\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">const</span> dbWorker <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./server/services/dbWorker.js\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token comment\">/**\r\n   * Send a message to the database worker thread\r\n   * telling it to connect to the MongoDb.\r\n   */</span>\r\n  dbWorker<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>status<span class=\"token operator\">:</span> <span class=\"token string\">'connect'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n  <span class=\"token comment\">/**\r\n   * Listening on feedback messages from the subscriberWorker\r\n   * The subscriberWorker has two message it sends to the main thread\r\n   * - 'subscribe' - means that it wants the main thread to start a new subscription\r\n   * - 'save' - means it has received event data that should be saved.\r\n   */</span>\r\n  subscribeWorker<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">incoming</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// destructure incoming message to read status</span>\r\n    <span class=\"token comment\">// and possible data related to the status</span>\r\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> status<span class=\"token punctuation\">,</span> data <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> incoming\r\n    \r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> status <span class=\"token operator\">===</span> <span class=\"token string\">'subscribe'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// send a message and tell the subscriberWorker to re-start  </span>\r\n      subscribeWorker<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token string\">'subscribe'</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> status <span class=\"token operator\">===</span> <span class=\"token string\">'save'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// send a message to the dbWorker to save the data</span>\r\n      dbWorker<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>status<span class=\"token operator\">:</span> <span class=\"token string\">'save'</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">:</span> data<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n  <span class=\"token comment\">// Basic error handling for the subscriberWorker</span>\r\n  subscribeWorker<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">code</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Subscribe Worker error with exit code </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>code<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  subscribeWorker<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"exit\"</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">code</span> <span class=\"token operator\">=></span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Subscribe Worker stopped with exit code </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>code<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">)</span>\r\n\r\n  <span class=\"token comment\">/**\r\n   * Listening on feedback messages from databaseWorker\r\n   * The databaseWorker sending only one message, 'subscribe'\r\n   * and it will do so after a successful connection has established\r\n   * and after data has been saved\r\n   */</span>\r\n  dbWorker<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">incoming</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> status<span class=\"token punctuation\">,</span> data <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> incoming\r\n\r\n    <span class=\"token comment\">// Call subscription worker after data has been saved by the save worker</span>\r\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> status <span class=\"token operator\">===</span> <span class=\"token string\">'subscribe'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      subscribeWorker<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token string\">'subscribe'</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n  <span class=\"token comment\">// Basic error handling for the dbWorker</span>\r\n  dbWorker<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">code</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Save Worker error with exit code </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>code<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  dbWorker<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"exit\"</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">code</span> <span class=\"token operator\">=></span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Save Worker stopped with exit code </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>code<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token comment\">/**\r\n * Entry point to start everything \r\n */</span>\r\nmodule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">await</span> <span class=\"token function\">runService</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The implementation of the subscriberWorker:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token comment\">// .server/services/subscribeWorker.js</span>\r\n\r\n<span class=\"token comment\">/**\r\n * Subscriber worker thread module\r\n */</span>\r\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> parentPort <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"worker_threads\"</span><span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\">/**\r\n * XHR wrapper to call end point api\r\n * @type {getEventData}\r\n */</span>\r\n<span class=\"token keyword\">const</span> getEventData <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./getEventData\"</span><span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\">/**\r\n * Listening on messages from parent thread\r\n * It handles only one message that will tell it\r\n * to start subscribing\r\n */</span>\r\nparentPort<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">message</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span> message <span class=\"token operator\">===</span> <span class=\"token string\">'subscribe'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\">/**\r\n * Subscription function, using axios to get data from polling enabled API endpoint\r\n * @returns {Promise&lt;void>}\r\n */</span>\r\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">let</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getEventData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n\r\n  <span class=\"token comment\">// If no content</span>\r\n  <span class=\"token comment\">// Tell parent thread to start a new subscription</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>status <span class=\"token operator\">!==</span> <span class=\"token number\">200</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    parentPort<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>status<span class=\"token operator\">:</span> <span class=\"token string\">'subscribe'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n\r\n    <span class=\"token comment\">// Data has been retrieves</span>\r\n    <span class=\"token comment\">// Tell parent to deal with saving</span>\r\n    <span class=\"token keyword\">let</span> <span class=\"token punctuation\">{</span> data <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> response\r\n    parentPort<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>status<span class=\"token operator\">:</span> <span class=\"token string\">'save'</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">:</span> data<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>The implementation of the dbWorker:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-javascript line-numbers\"><code class=\"language-javascript\"><span class=\"token comment\">// .server/services/dbWorker.js</span>\r\n\r\n<span class=\"token comment\">/**\r\n * Database worker thread module\r\n */</span>\r\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> parentPort <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"worker_threads\"</span><span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\">// Mongoose stuff</span>\r\n<span class=\"token keyword\">const</span> config <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'../config'</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> mongoose <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mongoose\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> Schema <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span>Schema<span class=\"token punctuation\">;</span>\r\nmongoose<span class=\"token punctuation\">.</span>Promise <span class=\"token operator\">=</span> global<span class=\"token punctuation\">.</span>Promise<span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">const</span> schema <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Schema</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n  event<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> String <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  horse<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> Number<span class=\"token punctuation\">,</span> horse<span class=\"token operator\">:</span> String <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  time<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> Number <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">const</span> Model <span class=\"token operator\">=</span> mongoose<span class=\"token punctuation\">.</span><span class=\"token function\">model</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Result\"</span><span class=\"token punctuation\">,</span> schema<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token comment\">/**\r\n * Listening on messages from parent thread\r\n * The parent thread sends two message\r\n * 'connect' to tell to connect to the database\r\n * 'save' to save the event data to the database\r\n */</span>\r\nparentPort<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">incoming</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> status<span class=\"token punctuation\">,</span> data <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> incoming<span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token comment\">// Parent issued a connect message</span>\r\n  <span class=\"token comment\">// After connection is successful - send a message </span>\r\n  <span class=\"token comment\">// to the parent thread to start subscribing</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">\"connect\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    mongoose\r\n      <span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>mongoUri<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>mongoOptions<span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Mongoose connected successfully\"</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>mongoUri<span class=\"token punctuation\">)</span>\r\n\r\n        <span class=\"token comment\">// Tell parent thread to start a new subscription</span>\r\n        parentPort<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> status<span class=\"token operator\">:</span> <span class=\"token string\">\"subscribe\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Mongoose connected failed: \"</span> <span class=\"token operator\">+</span> error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token comment\">// Parent thread send us a 'save' message</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status <span class=\"token operator\">===</span> <span class=\"token string\">\"save\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">saveData</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token comment\">/**\r\n * Save data to mongo db\r\n * @param data\r\n * @returns {Promise&lt;void>}\r\n */</span>\r\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">saveData</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  \r\n  <span class=\"token comment\">// save data</span>\r\n  <span class=\"token keyword\">const</span> document <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Model</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">await</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n\r\n  <span class=\"token comment\">// When data is saved - tell parent to start a new subscription</span>\r\n  parentPort<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> status<span class=\"token operator\">:</span> <span class=\"token string\">\"subscribe\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span>\r\n</code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<h2>Summary</h2>\n<p>It was really fun to experiment with worker threads and I think it will be used quiet often but, use it with care because\r\nI think postMessage API can bli slow in itself, however, that may have changed today.</p>\n<p>Possible uses cases?</p>\n<ul>\n<li>Serializing to JSON large responses to API requests, such as those resulting from GraphQL or objection.js relation</li>\n</ul>\n<p>graph queries</p>\n<ul>\n<li>Evaluating complex business logic rules on large data volumes (e.g. dynamic pricing of many products)</li>\n<li>Collecting and transforming larger bunches of data from the database for e.g. generating some single report or document</li>\n<li>Parsing large complex documents to an easily queryable representation, e.g. when web scraping</li>\n</ul>"}},"pageContext":{"slug":"/articles/nodejs-worker-threads/"}},"staticQueryHashes":["4011214723"]}
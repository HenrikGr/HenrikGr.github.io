<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.d6d95d1a5136c90afdf2.css">code[class*=language-],pre[class*=language-]{text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#eee;background:#272822;font-family:Roboto Mono,monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{background:#363636}:not(pre)>code[class*=language-]{white-space:normal;border-radius:.2em;padding:.1em}pre[class*=language-]{overflow:auto;position:relative;margin:.5em 0;padding:1.25em 1em}.language-css>code,.language-sass>code,.language-scss>code{color:#fd9170}[class*=language-] .namespace{opacity:.7}.token.atrule{color:#c792ea}.token.attr-name{color:#ffcb6b}.token.attr-value,.token.attribute{color:#a5e844}.token.boolean{color:#c792ea}.token.builtin{color:#ffcb6b}.token.cdata,.token.char{color:#80cbc4}.token.class{color:#ffcb6b}.token.class-name{color:#f2ff00}.token.comment{color:#616161}.token.constant{color:#c792ea}.token.deleted{color:#f66}.token.doctype{color:#616161}.token.entity{color:#f66}.token.function{color:#c792ea}.token.hexcode{color:#f2ff00}.token.id,.token.important{color:#c792ea;font-weight:700}.token.inserted{color:#80cbc4}.token.keyword{color:#c792ea}.token.number{color:#fd9170}.token.operator{color:#89ddff}.token.prolog{color:#616161}.token.property{color:#80cbc4}.token.pseudo-class,.token.pseudo-element{color:#a5e844}.token.punctuation{color:#89ddff}.token.regex{color:#f2ff00}.token.selector{color:#f66}.token.string{color:#a5e844}.token.symbol{color:#c792ea}.token.tag{color:#f66}.token.unit{color:#fd9170}.token.url,.token.variable{color:#f66}pre[class*=language-].line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}pre[class*=language-].line-numbers>code{position:relative;white-space:inherit}.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:0;font-size:100%;left:-3.8em;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-ms-user-select:none;user-select:none}.line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}h1{font-size:1.5rem;font-weight:400;line-height:1.34;letter-spacing:0;margin-top:.7em}h1,h2{font-family:Roboto,Helvetica,Arial,sans-serif;margin-bottom:.4em}h2{font-size:1.25rem;font-weight:500;line-height:1.6;letter-spacing:.0075rem;margin-top:.6em}h3{font-family:Roboto,Helvetica,Arial,sans-serif;font-size:.875rem;font-weight:600;line-height:1.58;letter-spacing:.00714rem;margin-top:.5em;margin-bottom:.4em}caption{font-size:.75rem;line-height:1.67;letter-spacing:.03333rem;margin:0}caption,p{font-family:Roboto,Helvetica,Arial,sans-serif;font-weight:400}p{margin-top:.4em;margin-bottom:.74em}li,p{font-size:.875rem;line-height:1.5;letter-spacing:.01786rem}li{font-family:Roboto,Helvetica,Arial,sans-serif;font-weight:400;margin:8px 0 0}blockquote{margin:0 0 16px;padding:16px;border-left:5px solid #9c27b0;background-color:#fff;color:#000}.gatsby-highlight{background-color:#272822;border-radius:.4em;margin:1.4em 0;padding:1em;overflow:auto}.gatsby-highlight pre[class*=language-].line-numbers{padding:0 0 0 2.8em;overflow:initial}.gatsby-highlight-code-line{background-color:#000;display:block;margin-right:-1em;margin-left:-1em;padding-right:1em;padding-left:.75em;border-left:.25em solid #111}</style><meta name="generator" content="Gatsby 2.18.22"/><title data-react-helmet="true">Henrik Grönvall - Node.js worker threads</title><link data-react-helmet="true" href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&amp;display=swap" rel="stylesheet"/><meta data-react-helmet="true" name="description" content="Worker Threads are available in the Node.js module. Before we dive into my example use of Worker threads in Node.js, 
we will see what are worker threads and…"/><meta data-react-helmet="true" name="keywords" content="JavaScript,React,Node.js,HTML,CSS,Cloud"/><style id="jss-server-side">.MuiToolbar-root{display:-webkit-box;display:flex;position:relative;-webkit-box-align:center;align-items:center}.MuiToolbar-gutters{padding-left:16px;padding-right:16px}@media (min-width:600px){.MuiToolbar-gutters{padding-left:24px;padding-right:24px}}.MuiToolbar-regular{min-height:56px}@media (min-width:0px) and (orientation:landscape){.MuiToolbar-regular{min-height:48px}}@media (min-width:600px){.MuiToolbar-regular{min-height:64px}}.MuiToolbar-dense{min-height:48px}.jss97{padding-top:16px;padding-bottom:16px}.jss110{padding-top:16px;padding-left:16px;padding-right:16px;padding-bottom:16px}.jss111{padding-top:8px;padding-bottom:8px}.MuiTypography-root{margin:0}.MuiTypography-body2{font-size:.875rem;font-family:Roboto,Helvetica,Arial,sans-serif;font-weight:400;line-height:1.43;letter-spacing:.01071em}.MuiTypography-body1{font-size:1rem;font-family:Roboto,Helvetica,Arial,sans-serif;font-weight:400;line-height:1.5;letter-spacing:.00938em}.MuiTypography-caption{font-size:.75rem;font-family:Roboto,Helvetica,Arial,sans-serif;font-weight:400;line-height:1.66;letter-spacing:.03333em}.MuiTypography-button{font-size:.875rem;font-family:Roboto,Helvetica,Arial,sans-serif;font-weight:500;line-height:1.75;letter-spacing:.02857em;text-transform:uppercase}.MuiTypography-h1{font-size:6rem;font-family:Roboto,Helvetica,Arial,sans-serif;font-weight:300;line-height:1.167;letter-spacing:-.01562em}.MuiTypography-h2{font-size:3.75rem;font-family:Roboto,Helvetica,Arial,sans-serif;font-weight:300;line-height:1.2;letter-spacing:-.00833em}.MuiTypography-h3{font-size:3rem;font-family:Roboto,Helvetica,Arial,sans-serif;font-weight:400;line-height:1.167;letter-spacing:0}.MuiTypography-h4{font-size:2.125rem;font-family:Roboto,Helvetica,Arial,sans-serif;font-weight:400;line-height:1.235;letter-spacing:.00735em}.MuiTypography-h5{font-size:1.5rem;font-family:Roboto,Helvetica,Arial,sans-serif;font-weight:400;line-height:1.334;letter-spacing:0}.MuiTypography-h6{font-size:1.25rem;font-family:Roboto,Helvetica,Arial,sans-serif;font-weight:500;line-height:1.6;letter-spacing:.0075em}.MuiTypography-subtitle1{font-size:1rem;font-family:Roboto,Helvetica,Arial,sans-serif;font-weight:400;line-height:1.75;letter-spacing:.00938em}.MuiTypography-subtitle2{font-size:.875rem;font-family:Roboto,Helvetica,Arial,sans-serif;font-weight:500;line-height:1.57;letter-spacing:.00714em}.MuiTypography-overline{font-size:.75rem;font-family:Roboto,Helvetica,Arial,sans-serif;font-weight:400;line-height:2.66;letter-spacing:.08333em;text-transform:uppercase}.MuiTypography-srOnly{width:1px;height:1px;overflow:hidden;position:absolute}.MuiTypography-alignLeft{text-align:left}.MuiTypography-alignCenter{text-align:center}.MuiTypography-alignRight{text-align:right}.MuiTypography-alignJustify{text-align:justify}.MuiTypography-noWrap{overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.MuiTypography-gutterBottom{margin-bottom:.35em}.MuiTypography-paragraph{margin-bottom:16px}.MuiTypography-colorInherit{color:inherit}.MuiTypography-colorPrimary{color:#3f51b5}.MuiTypography-colorSecondary{color:#f50057}.MuiTypography-colorTextPrimary{color:rgba(0,0,0,.87)}.MuiTypography-colorTextSecondary{color:rgba(0,0,0,.54)}.MuiTypography-colorError{color:#f44336}.MuiTypography-displayInline{display:inline}.MuiTypography-displayBlock{display:block}.MuiPaper-root{color:rgba(0,0,0,.87);-webkit-transition:box-shadow .3s cubic-bezier(.4,0,.2,1) 0s;transition:box-shadow .3s cubic-bezier(.4,0,.2,1) 0s;background-color:#fff}.MuiPaper-rounded{border-radius:4px}.MuiPaper-outlined{border:1px solid rgba(0,0,0,.12)}.MuiPaper-elevation0{box-shadow:none}.MuiPaper-elevation1{box-shadow:0 2px 1px -1px rgba(0,0,0,.2),0 1px 1px 0 rgba(0,0,0,.14),0 1px 3px 0 rgba(0,0,0,.12)}.MuiPaper-elevation2{box-shadow:0 3px 1px -2px rgba(0,0,0,.2),0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12)}.MuiPaper-elevation3{box-shadow:0 3px 3px -2px rgba(0,0,0,.2),0 3px 4px 0 rgba(0,0,0,.14),0 1px 8px 0 rgba(0,0,0,.12)}.MuiPaper-elevation4{box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)}.MuiPaper-elevation5{box-shadow:0 3px 5px -1px rgba(0,0,0,.2),0 5px 8px 0 rgba(0,0,0,.14),0 1px 14px 0 rgba(0,0,0,.12)}.MuiPaper-elevation6{box-shadow:0 3px 5px -1px rgba(0,0,0,.2),0 6px 10px 0 rgba(0,0,0,.14),0 1px 18px 0 rgba(0,0,0,.12)}.MuiPaper-elevation7{box-shadow:0 4px 5px -2px rgba(0,0,0,.2),0 7px 10px 1px rgba(0,0,0,.14),0 2px 16px 1px rgba(0,0,0,.12)}.MuiPaper-elevation8{box-shadow:0 5px 5px -3px rgba(0,0,0,.2),0 8px 10px 1px rgba(0,0,0,.14),0 3px 14px 2px rgba(0,0,0,.12)}.MuiPaper-elevation9{box-shadow:0 5px 6px -3px rgba(0,0,0,.2),0 9px 12px 1px rgba(0,0,0,.14),0 3px 16px 2px rgba(0,0,0,.12)}.MuiPaper-elevation10{box-shadow:0 6px 6px -3px rgba(0,0,0,.2),0 10px 14px 1px rgba(0,0,0,.14),0 4px 18px 3px rgba(0,0,0,.12)}.MuiPaper-elevation11{box-shadow:0 6px 7px -4px rgba(0,0,0,.2),0 11px 15px 1px rgba(0,0,0,.14),0 4px 20px 3px rgba(0,0,0,.12)}.MuiPaper-elevation12{box-shadow:0 7px 8px -4px rgba(0,0,0,.2),0 12px 17px 2px rgba(0,0,0,.14),0 5px 22px 4px rgba(0,0,0,.12)}.MuiPaper-elevation13{box-shadow:0 7px 8px -4px rgba(0,0,0,.2),0 13px 19px 2px rgba(0,0,0,.14),0 5px 24px 4px rgba(0,0,0,.12)}.MuiPaper-elevation14{box-shadow:0 7px 9px -4px rgba(0,0,0,.2),0 14px 21px 2px rgba(0,0,0,.14),0 5px 26px 4px rgba(0,0,0,.12)}.MuiPaper-elevation15{box-shadow:0 8px 9px -5px rgba(0,0,0,.2),0 15px 22px 2px rgba(0,0,0,.14),0 6px 28px 5px rgba(0,0,0,.12)}.MuiPaper-elevation16{box-shadow:0 8px 10px -5px rgba(0,0,0,.2),0 16px 24px 2px rgba(0,0,0,.14),0 6px 30px 5px rgba(0,0,0,.12)}.MuiPaper-elevation17{box-shadow:0 8px 11px -5px rgba(0,0,0,.2),0 17px 26px 2px rgba(0,0,0,.14),0 6px 32px 5px rgba(0,0,0,.12)}.MuiPaper-elevation18{box-shadow:0 9px 11px -5px rgba(0,0,0,.2),0 18px 28px 2px rgba(0,0,0,.14),0 7px 34px 6px rgba(0,0,0,.12)}.MuiPaper-elevation19{box-shadow:0 9px 12px -6px rgba(0,0,0,.2),0 19px 29px 2px rgba(0,0,0,.14),0 7px 36px 6px rgba(0,0,0,.12)}.MuiPaper-elevation20{box-shadow:0 10px 13px -6px rgba(0,0,0,.2),0 20px 31px 3px rgba(0,0,0,.14),0 8px 38px 7px rgba(0,0,0,.12)}.MuiPaper-elevation21{box-shadow:0 10px 13px -6px rgba(0,0,0,.2),0 21px 33px 3px rgba(0,0,0,.14),0 8px 40px 7px rgba(0,0,0,.12)}.MuiPaper-elevation22{box-shadow:0 10px 14px -6px rgba(0,0,0,.2),0 22px 35px 3px rgba(0,0,0,.14),0 8px 42px 7px rgba(0,0,0,.12)}.MuiPaper-elevation23{box-shadow:0 11px 14px -7px rgba(0,0,0,.2),0 23px 36px 3px rgba(0,0,0,.14),0 9px 44px 8px rgba(0,0,0,.12)}.MuiPaper-elevation24{box-shadow:0 11px 15px -7px rgba(0,0,0,.2),0 24px 38px 3px rgba(0,0,0,.14),0 9px 46px 8px rgba(0,0,0,.12)}.MuiCard-root{overflow:hidden}.MuiContainer-root{width:100%;box-sizing:border-box;margin-left:auto;margin-right:auto;padding-left:16px;padding-right:16px}@media (min-width:600px){.MuiContainer-root{padding-left:24px;padding-right:24px}}@media (min-width:960px){.MuiContainer-root{padding-left:32px;padding-right:32px}}.MuiContainer-disableGutters{padding-left:0;padding-right:0}@media (min-width:600px){.MuiContainer-fixed{max-width:600px}}@media (min-width:960px){.MuiContainer-fixed{max-width:960px}}@media (min-width:1280px){.MuiContainer-fixed{max-width:1280px}}@media (min-width:1920px){.MuiContainer-fixed{max-width:1920px}}@media (min-width:0px){.MuiContainer-maxWidthXs{max-width:444px}}@media (min-width:600px){.MuiContainer-maxWidthSm{max-width:600px}}@media (min-width:960px){.MuiContainer-maxWidthMd{max-width:960px}}@media (min-width:1280px){.MuiContainer-maxWidthLg{max-width:1280px}}@media (min-width:1920px){.MuiContainer-maxWidthXl{max-width:1920px}}.MuiCardMedia-root{display:block;background-size:cover;background-repeat:no-repeat;background-position:center}.MuiCardMedia-media{width:100%}.MuiCardMedia-img{-o-object-fit:cover;object-fit:cover}.MuiDivider-root{border:none;height:1px;margin:0;flex-shrink:0;background-color:rgba(0,0,0,.12)}.MuiDivider-absolute{left:0;width:100%;bottom:0;position:absolute}.MuiDivider-inset{margin-left:72px}.MuiDivider-light{background-color:rgba(0,0,0,.08)}.MuiDivider-middle{margin-left:16px;margin-right:16px}.MuiDivider-vertical{width:1px;height:100%}.MuiButtonBase-root{color:inherit;border:0;cursor:pointer;margin:0;display:-webkit-inline-box;display:inline-flex;outline:0;padding:0;position:relative;-webkit-box-align:center;align-items:center;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;border-radius:0;vertical-align:middle;-moz-appearance:none;-webkit-box-pack:center;justify-content:center;text-decoration:none;background-color:transparent;-webkit-appearance:none;-webkit-tap-highlight-color:transparent}.MuiButtonBase-root::-moz-focus-inner{border-style:none}.MuiButtonBase-root.Mui-disabled{cursor:default;pointer-events:none}.MuiFab-root{color:rgba(0,0,0,.87);width:56px;height:56px;padding:0;font-size:.875rem;min-width:0;box-shadow:0 3px 5px -1px rgba(0,0,0,.2),0 6px 10px 0 rgba(0,0,0,.14),0 1px 18px 0 rgba(0,0,0,.12);box-sizing:border-box;min-height:36px;-webkit-transition:background-color 250ms cubic-bezier(.4,0,.2,1) 0s,box-shadow 250ms cubic-bezier(.4,0,.2,1) 0s,border 250ms cubic-bezier(.4,0,.2,1) 0s;transition:background-color 250ms cubic-bezier(.4,0,.2,1) 0s,box-shadow 250ms cubic-bezier(.4,0,.2,1) 0s,border 250ms cubic-bezier(.4,0,.2,1) 0s;font-family:Roboto,Helvetica,Arial,sans-serif;font-weight:500;line-height:1.75;border-radius:50%;letter-spacing:.02857em;text-transform:uppercase;background-color:#e0e0e0}.MuiFab-root:active{box-shadow:0 7px 8px -4px rgba(0,0,0,.2),0 12px 17px 2px rgba(0,0,0,.14),0 5px 22px 4px rgba(0,0,0,.12)}.MuiFab-root.Mui-focusVisible{box-shadow:0 3px 5px -1px rgba(0,0,0,.2),0 6px 10px 0 rgba(0,0,0,.14),0 1px 18px 0 rgba(0,0,0,.12)}.MuiFab-root:hover{text-decoration:none;background-color:#d5d5d5}.MuiFab-root.Mui-disabled{color:rgba(0,0,0,.26);box-shadow:none;background-color:rgba(0,0,0,.12)}@media (hover:none){.MuiFab-root:hover{background-color:#e0e0e0}}.MuiFab-root:hover.Mui-disabled{background-color:rgba(0,0,0,.12)}.MuiFab-label{width:100%;display:inherit;-webkit-box-align:inherit;align-items:inherit;-webkit-box-pack:inherit;justify-content:inherit}.MuiFab-primary{color:#fff;background-color:#3f51b5}.MuiFab-primary:hover{background-color:#303f9f}@media (hover:none){.MuiFab-primary:hover{background-color:#3f51b5}}.MuiFab-secondary{color:#fff;background-color:#f50057}.MuiFab-secondary:hover{background-color:#c51162}@media (hover:none){.MuiFab-secondary:hover{background-color:#f50057}}.MuiFab-extended{width:auto;height:48px;padding:0 16px;min-width:48px;min-height:auto;border-radius:24px}.MuiFab-extended.MuiFab-sizeSmall{width:auto;height:34px;padding:0 8px;min-width:34px;border-radius:17px}.MuiFab-extended.MuiFab-sizeMedium{width:auto;height:40px;padding:0 16px;min-width:40px;border-radius:20px}.MuiFab-colorInherit{color:inherit}.MuiFab-sizeSmall{width:40px;height:40px}.MuiFab-sizeMedium{width:48px;height:48px}.MuiSvgIcon-root{fill:currentColor;width:1em;height:1em;display:inline-block;font-size:1.5rem;-webkit-transition:fill .2s cubic-bezier(.4,0,.2,1) 0s;transition:fill .2s cubic-bezier(.4,0,.2,1) 0s;flex-shrink:0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.MuiSvgIcon-colorPrimary{color:#3f51b5}.MuiSvgIcon-colorSecondary{color:#f50057}.MuiSvgIcon-colorAction{color:rgba(0,0,0,.54)}.MuiSvgIcon-colorError{color:#f44336}.MuiSvgIcon-colorDisabled{color:rgba(0,0,0,.26)}.MuiSvgIcon-fontSizeInherit{font-size:inherit}.MuiSvgIcon-fontSizeSmall{font-size:1.25rem}.MuiSvgIcon-fontSizeLarge{font-size:2.1875rem}.MuiAppBar-root{width:100%;display:-webkit-box;display:flex;z-index:1100;box-sizing:border-box;flex-shrink:0;-webkit-box-orient:vertical;-webkit-box-direction:normal;flex-direction:column}.MuiAppBar-positionFixed{top:0;left:auto;right:0;position:fixed}@media print{.MuiAppBar-positionFixed{position:absolute}}.MuiAppBar-positionAbsolute{top:0;left:auto;right:0;position:absolute}.MuiAppBar-positionSticky{top:0;left:auto;right:0;position:-webkit-sticky;position:sticky}.MuiAppBar-positionStatic{position:static;-webkit-transform:translateZ(0);transform:translateZ(0)}.MuiAppBar-positionRelative{position:relative}.MuiAppBar-colorDefault{color:rgba(0,0,0,.87);background-color:#f5f5f5}.MuiAppBar-colorPrimary{color:#fff;background-color:#3f51b5}.MuiAppBar-colorSecondary{color:#fff;background-color:#f50057}.MuiIconButton-root{-webkit-box-flex:0;flex:0 0 auto;color:rgba(0,0,0,.54);padding:12px;overflow:visible;font-size:1.5rem;text-align:center;-webkit-transition:background-color 150ms cubic-bezier(.4,0,.2,1) 0s;transition:background-color 150ms cubic-bezier(.4,0,.2,1) 0s;border-radius:50%}.MuiIconButton-root:hover{background-color:rgba(0,0,0,.08)}.MuiIconButton-root.Mui-disabled{color:rgba(0,0,0,.26);background-color:transparent}@media (hover:none){.MuiIconButton-root:hover{background-color:transparent}}.MuiIconButton-edgeStart{margin-left:-12px}.MuiIconButton-sizeSmall.MuiIconButton-edgeStart{margin-left:-3px}.MuiIconButton-edgeEnd{margin-right:-12px}.MuiIconButton-sizeSmall.MuiIconButton-edgeEnd{margin-right:-3px}.MuiIconButton-colorInherit{color:inherit}.MuiIconButton-colorPrimary{color:#3f51b5}.MuiIconButton-colorPrimary:hover{background-color:rgba(63,81,181,.08)}@media (hover:none){.MuiIconButton-colorPrimary:hover{background-color:transparent}}.MuiIconButton-colorSecondary{color:#f50057}.MuiIconButton-colorSecondary:hover{background-color:rgba(245,0,87,.08)}@media (hover:none){.MuiIconButton-colorSecondary:hover{background-color:transparent}}.MuiIconButton-sizeSmall{padding:3px;font-size:1.125rem}.MuiIconButton-label{width:100%;display:-webkit-box;display:flex;-webkit-box-align:inherit;align-items:inherit;-webkit-box-pack:inherit;justify-content:inherit}.jss118{right:16px;bottom:16px;position:fixed}.MuiLink-underlineNone{text-decoration:none}.MuiLink-underlineHover{text-decoration:none}.MuiLink-underlineHover:hover{text-decoration:underline}.MuiLink-underlineAlways{text-decoration:underline}.MuiLink-button{border:0;cursor:pointer;margin:0;outline:0;padding:0;position:relative;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;border-radius:0;vertical-align:middle;-moz-appearance:none;background-color:transparent;-webkit-appearance:none;-webkit-tap-highlight-color:transparent}.MuiLink-button::-moz-focus-inner{border-style:none}.MuiLink-button.Mui-focusVisible{outline:auto}.jss129{color:#fff;padding:48px 0;margin-top:64px;background-color:#3f51b5}.jss1{height:210px}.jss2{font-size:14px;padding-top:16px}.jss3{font-size:14px}</style><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link as="script" rel="preload" href="/webpack-runtime-6bd6d379b3148f0c5306.js"/><link as="script" rel="preload" href="/app-975a12177bf1439bf53d.js"/><link as="script" rel="preload" href="/styles-8dc85704fa2b8d8e1fea.js"/><link as="script" rel="preload" href="/commons-1689ca55c1e5991db044.js"/><link as="script" rel="preload" href="/component---src-templates-article-page-template-js-2e6819825b5a64efc317.js"/><link as="fetch" rel="preload" href="/page-data\articles\nodejs-worker-threads\page-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><header class="MuiPaper-root MuiAppBar-root MuiAppBar-positionFixed MuiAppBar-colorPrimary mui-fixed MuiPaper-elevation0"><div class="MuiToolbar-root MuiToolbar-regular MuiToolbar-gutters"><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-colorInherit MuiIconButton-edgeStart" tabindex="0" type="button" aria-label="menu"><span class="MuiIconButton-label"><svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true" role="presentation"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg></span></button><h6 class="MuiTypography-root MuiTypography-subtitle1 MuiTypography-colorInherit">Node.js worker threads</h6></div></header><div class="MuiToolbar-root MuiToolbar-regular MuiToolbar-gutters" id="back-to-top-anchor"></div><div class="MuiContainer-root MuiBox-root jss97 MuiContainer-maxWidthMd"><div class="MuiPaper-root MuiCard-root MuiPaper-elevation1 MuiPaper-rounded"><div class="MuiCardMedia-root jss1" style="background-image:url(&quot;https://source.unsplash.com/random?christmas&quot;)"></div><div class="MuiBox-root jss110"><div><p>Worker Threads are available in the Node.js module. Before we dive into my example use of Worker threads in Node.js,
we will see what are worker threads and why we "could" need it in Node.js.</p>
<h1>Understand Node.js and worker threads</h1>
<p>When a Node.js process is launched, it runs:</p>
<ol>
<li>One process:
A process is a global object that can be accessed anywhere and has information about what’s being executed at a time.</li>
<li>One thread:
Being single-threaded means that only one set of instructions is executed at a time in a given process.</li>
<li>One event loop:
This is one of the most important aspects to understand about Node. It’s what allows Node to be asynchronous and have
non-blocking I/O, — despite the fact that JavaScript is single-threaded — by offloading operations to the system kernel
whenever possible through callbacks, promises and async/await.</li>
<li>One JS Engine Instance:
This is a computer program that executes JavaScript code.</li>
<li>One Node.js Instance:
The computer program that executes Node.js code.</li>
</ol>
<p>In other words, Node.js runs on a single thread, and there is just one process happening at a time in the event loop.
The code is NOT executed in parallel and you do not need to worry about concurrency issues.</p>
<p><b>There is a downside tough</b>: if you have CPU-intensive code, like complex calculations in a large dataset taking
place in-memory, it can block other processes from being executed. </p>
<blockquote>
<p>The golden rule: don’t block the event loop, try to keep it running and pay attention and avoid anything that could
block the thread like synchronous network calls or infinite loops.</p>
</blockquote>
<p>It’s important to differentiate between CPU operations and I/O (input/output) operations. As mentioned earlier, the code
of Node.js is NOT executed in parallel. Only I/O operations are run in parallel, because they are executed asynchronously.</p>
<p>So Worker Threads will not help much with I/O-intensive work because asynchronous I/O operations are more efficient than
Workers can be. The main goal of Workers is to improve the performance on CPU-intensive operations not I/O operations.</p>
<h1>When to use worker threads?</h1>
<p>The best solution for CPU performance is Worker Threads. Browsers have had the concept of Workers for a long time.</p>
<p>Instead of having:</p>
<ol>
<li>One process</li>
<li>One thread</li>
<li>One event loop</li>
<li>One JS Engine Instance</li>
<li>One Node.js Instance</li>
</ol>
<p>Worker threads have:</p>
<ol>
<li>One process</li>
<li>Multiple threads</li>
<li>One event loop per thread</li>
<li>One JS Engine Instance per thread</li>
<li>One Node.js Instance per thread</li>
</ol>
<h1>Experiment</h1>
<p>In my example I have an external service that can be "considered" having CPU intensive calculations, it is a Rest API
endpoint built to enable long polling and can after 15 seconds require the client to make a new request. If 15 seconds
has been reached the service responds with a status 204. The external services will in normal cases respond with event
data from trot races with a start and finish event and id plus time for any horse in the race.</p>
<p>The external service will respond with event data for start time and finnish time for horses in trot races:</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// Start data</span>
<span class="token punctuation">{</span>
  event<span class="token operator">:</span> <span class="token string">"start"</span><span class="token punctuation">,</span>
  horse<span class="token operator">:</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">'Spin Scorpion'</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  time<span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token comment">// Goal data</span>
<span class="token punctuation">{</span>
  event<span class="token operator">:</span> <span class="token string">"finish"</span><span class="token punctuation">,</span>
  horse<span class="token operator">:</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">'Spin Scorpion'</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  time<span class="token operator">:</span> <span class="token number">13230</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>First we start by implementing the Node.js server using Express.js that are going to run the worker threads for subscribing
on trot race data and storing it in the database.</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// server.js</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./config"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"express"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> run <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./services"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Run worker threads to subscribe and save data
 */</span>
<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>port<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>appName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> listening on: http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> server<span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>The module responsible for all communication between the main thread and the worker threads exports only one
async function, called run and in this little experiment it starts everything.</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// .server/services/index.js</span>

<span class="token comment">/**
 * We import the Node.js module for worker threads
 */</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Worker <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"worker_threads"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Services that handles all messages between 
 * the main thread and worker threads
 * @returns {Promise&lt;void>}
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Create two new worker threads, </span>
  <span class="token comment">// - on for subscription of trot events, </span>
  <span class="token comment">// - one to store event data in a MongoDb </span>
  <span class="token keyword">const</span> subscribeWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">"./server/services/subscribeWorker.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> dbWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">"./server/services/dbWorker.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * Send a message to the database worker thread
   * telling it to connect to the MongoDb.
   */</span>
  dbWorker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>status<span class="token operator">:</span> <span class="token string">'connect'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">/**
   * Listening on feedback messages from the subscriberWorker
   * The subscriberWorker has two message it sends to the main thread
   * - 'subscribe' - means that it wants the main thread to start a new subscription
   * - 'save' - means it has received event data that should be saved.
   */</span>
  subscribeWorker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token parameter">incoming</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// destructure incoming message to read status</span>
    <span class="token comment">// and possible data related to the status</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> status<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> incoming
    
    <span class="token keyword">if</span><span class="token punctuation">(</span> status <span class="token operator">===</span> <span class="token string">'subscribe'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// send a message and tell the subscriberWorker to re-start  </span>
      subscribeWorker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'subscribe'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> status <span class="token operator">===</span> <span class="token string">'save'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// send a message to the dbWorker to save the data</span>
      dbWorker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>status<span class="token operator">:</span> <span class="token string">'save'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> data<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// Basic error handling for the subscriberWorker</span>
  subscribeWorker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token parameter">code</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Subscribe Worker error with exit code </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  subscribeWorker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"exit"</span><span class="token punctuation">,</span> <span class="token parameter">code</span> <span class="token operator">=></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Subscribe Worker stopped with exit code </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

  <span class="token comment">/**
   * Listening on feedback messages from databaseWorker
   * The databaseWorker sending only one message, 'subscribe'
   * and it will do so after a successful connection has established
   * and after data has been saved
   */</span>
  dbWorker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token parameter">incoming</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> status<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> incoming

    <span class="token comment">// Call subscription worker after data has been saved by the save worker</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> status <span class="token operator">===</span> <span class="token string">'subscribe'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      subscribeWorker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'subscribe'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// Basic error handling for the dbWorker</span>
  dbWorker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token parameter">code</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Save Worker error with exit code </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  dbWorker<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"exit"</span><span class="token punctuation">,</span> <span class="token parameter">code</span> <span class="token operator">=></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Save Worker stopped with exit code </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Entry point to start everything 
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">runService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>The implementation of the subscriberWorker:</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// .server/services/subscribeWorker.js</span>

<span class="token comment">/**
 * Subscriber worker thread module
 */</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> parentPort <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"worker_threads"</span><span class="token punctuation">)</span>

<span class="token comment">/**
 * XHR wrapper to call end point api
 * @type {getEventData}
 */</span>
<span class="token keyword">const</span> getEventData <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./getEventData"</span><span class="token punctuation">)</span>

<span class="token comment">/**
 * Listening on messages from parent thread
 * It handles only one message that will tell it
 * to start subscribing
 */</span>
parentPort<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token parameter">message</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span> message <span class="token operator">===</span> <span class="token string">'subscribe'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">/**
 * Subscription function, using axios to get data from polling enabled API endpoint
 * @returns {Promise&lt;void>}
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getEventData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// If no content</span>
  <span class="token comment">// Tell parent thread to start a new subscription</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    parentPort<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>status<span class="token operator">:</span> <span class="token string">'subscribe'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

    <span class="token comment">// Data has been retrieves</span>
    <span class="token comment">// Tell parent to deal with saving</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> response
    parentPort<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>status<span class="token operator">:</span> <span class="token string">'save'</span><span class="token punctuation">,</span> data<span class="token operator">:</span> data<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>The implementation of the dbWorker:</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token comment">// .server/services/dbWorker.js</span>

<span class="token comment">/**
 * Database worker thread module
 */</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> parentPort <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"worker_threads"</span><span class="token punctuation">)</span>

<span class="token comment">// Mongoose stuff</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mongoose"</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Schema <span class="token operator">=</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">;</span>
mongoose<span class="token punctuation">.</span>Promise <span class="token operator">=</span> global<span class="token punctuation">.</span>Promise<span class="token punctuation">;</span>
<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  event<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span>
  horse<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> Number<span class="token punctuation">,</span> horse<span class="token operator">:</span> String <span class="token punctuation">}</span><span class="token punctuation">,</span>
  time<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> Number <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Model <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">"Result"</span><span class="token punctuation">,</span> schema<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Listening on messages from parent thread
 * The parent thread sends two message
 * 'connect' to tell to connect to the database
 * 'save' to save the event data to the database
 */</span>
parentPort<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token parameter">incoming</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> status<span class="token punctuation">,</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> incoming<span class="token punctuation">;</span>

  <span class="token comment">// Parent issued a connect message</span>
  <span class="token comment">// After connection is successful - send a message </span>
  <span class="token comment">// to the parent thread to start subscribing</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">===</span> <span class="token string">"connect"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mongoose
      <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>mongoUri<span class="token punctuation">,</span> config<span class="token punctuation">.</span>mongoOptions<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Mongoose connected successfully"</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>mongoUri<span class="token punctuation">)</span>

        <span class="token comment">// Tell parent thread to start a new subscription</span>
        parentPort<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token string">"subscribe"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Mongoose connected failed: "</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Parent thread send us a 'save' message</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">===</span> <span class="token string">"save"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">saveData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Save data to mongo db
 * @param data
 * @returns {Promise&lt;void>}
 */</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">saveData</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  
  <span class="token comment">// save data</span>
  <span class="token keyword">const</span> document <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Model</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token keyword">await</span> document<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// When data is saved - tell parent to start a new subscription</span>
  parentPort<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token string">"subscribe"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h1>Summary</h1>
<p>It was really fun to experiment with worker threads and I think it will be used quiet often but, use it with care because
I think postMessage API can bli slow in itself, however, that may have changed today.</p>
<p>Possible uses cases?</p>
<ul>
<li>Serializing to JSON large responses to API requests, such as those resulting from GraphQL or objection.js relation
graph queries</li>
<li>Evaluating complex business logic rules on large data volumes (e.g. dynamic pricing of many products)</li>
<li>Collecting and transforming larger bunches of data from the database for e.g. generating some single report or document</li>
<li>Parsing large complex documents to an easily queryable representation, e.g. when web scraping </li>
</ul></div><div class="MuiBox-root jss111"><hr class="MuiDivider-root"/></div><h6 class="MuiTypography-root MuiTypography-subtitle2 MuiTypography-colorTextSecondary">Published: <!-- -->2019-11-14</h6><h6 class="MuiTypography-root MuiTypography-subtitle2 MuiTypography-colorTextSecondary">PublishedBy: <!-- -->Henrik Grönvall</h6></div></div></div><div role="presentation" class="jss118" style="transform:scale(0);visibility:hidden"><button class="MuiButtonBase-root MuiFab-root MuiFab-secondary" tabindex="0" type="button" aria-label="scroll back to top"><span class="MuiFab-label"><svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true" role="presentation"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path></svg></span></button></div><div class="MuiBox-root jss130 jss129"><h6 class="MuiTypography-root MuiTypography-h6 MuiTypography-gutterBottom MuiTypography-alignCenter">Henrik Grönvall</h6><p class="MuiTypography-root MuiTypography-body2 MuiTypography-colorInherit MuiTypography-alignCenter">Copyright © <!-- -->2020<!-- --> <a class="MuiTypography-root MuiLink-root MuiLink-underlineNone MuiTypography-colorInherit" href="/">Henrik Grönvall Consulting AB</a> <!-- -->.</p></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-152419885-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/articles/nodejs-worker-threads/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-975a12177bf1439bf53d.js"],"component---src-templates-project-page-template-js":["/component---src-templates-project-page-template-js-17050566e379773ed22f.js"],"component---src-templates-article-page-template-js":["/component---src-templates-article-page-template-js-2e6819825b5a64efc317.js"],"component---src-templates-articles-tags-template-js":["/component---src-templates-articles-tags-template-js-082eb26170aee69b6269.js"],"component---src-templates-news-page-template-js":["/component---src-templates-news-page-template-js-9d3152a40645c666549c.js"],"component---src-templates-about-page-template-js":["/component---src-templates-about-page-template-js-4dc3cff4dfe7b67de6f8.js"],"component---src-pages-404-js":["/component---src-pages-404-js-492263641e10b0ae7be5.js"],"component---src-pages-articles-js":["/component---src-pages-articles-js-fdbbc86a54e2bb9b8245.js"],"component---src-pages-index-js":["/component---src-pages-index-js-0c1ed36893841ef821b3.js"],"component---src-pages-news-js":["/component---src-pages-news-js-d399f8d276c2a7c81a12.js"],"component---src-pages-projects-js":["/component---src-pages-projects-js-d17cb1ca727dcce987e3.js"]};/*]]>*/</script><script src="/component---src-templates-article-page-template-js-2e6819825b5a64efc317.js" async=""></script><script src="/commons-1689ca55c1e5991db044.js" async=""></script><script src="/styles-8dc85704fa2b8d8e1fea.js" async=""></script><script src="/app-975a12177bf1439bf53d.js" async=""></script><script src="/webpack-runtime-6bd6d379b3148f0c5306.js" async=""></script></body></html>